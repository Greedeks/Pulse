<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pulse - GitHub Release Statistics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/components/buttons.css">
  <link rel="stylesheet" href="assets/css/components/card.css">
  <link rel="shortcut icon" href="assets/icon.ico" type="image/x-icon">
</head>
<body>

<div class="wrapper">
  <main class="main">
    <div class="header-text" style="text-align: center; margin-bottom: 0.5rem; padding: 0 1rem;">
      <h1 style="font-family: 'Roboto', sans-serif; font-weight: 500; font-size: clamp(1.9rem, 4.5vw, 2.5rem); color: #ffffff; margin-bottom: 0.5rem;">
        GitHub Release Statistics
      </h1>
    </div>
    <div class="preview">
      <div class="glass-window">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 1.2rem; margin-bottom: 1.5rem;">
          <a href="https://github.com/Greedeks/Pulse" target="_blank" style="color: #a4d7f4; text-decoration: none; font-size: 1.5rem; filter: drop-shadow(0 0 8px rgba(164, 215, 244, 0.6));">
            <i class="fab fa-github"></i>
          </a>
          <h2 style="margin: 0;">Profile & Repo Details</h2>
        </div>
        <form id="pulseForm">
          <input type="text" class="glass-input" name="username" placeholder="Username" required/>
          <input type="text" class="glass-input" name="repository" placeholder="Repository name" required/>
          <input type="text" class="glass-input" name="releaseTag" placeholder="Release tag (optional)" />
          <button type="submit" class="btn-glass">Submit</button>
        </form>
      </div>
    </div>

    <div class="content-container">
      <div class="content" id="releases"></div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('pulseForm');
  const container = document.querySelector('.content');

  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      username: params.get('username'),
      repo: params.get('repo'),
      tag: params.get('tag')
    };
  }

  function updateUrlParams(username, repo, tag='') {
    const params = new URLSearchParams();
    if(username) params.set('username', username);
    if(repo) params.set('repo', repo);
    if(tag) params.set('tag', tag);
    const newUrl = window.location.origin + window.location.pathname + '?' + params.toString();
    window.history.pushState({}, '', newUrl);
  }

  async function fetchAllReleases(username, repo) {
    let releases = [], page = 1;
    while(true) {
      const res = await fetch(`https://api.github.com/repos/${username}/${repo}/releases?page=${page}&per_page=30`);
      if(res.status === 403) throw new Error('GitHub API rate limit exceeded');
      if(res.status === 404) throw new Error('Repository not found');
      if(!res.ok) throw new Error(`API error: ${res.status}`);
      const data = await res.json();
      if(data.length===0) break;
      releases = releases.concat(data);
      page++;
    }
    return releases;
  }

  function autoFillFromUrl() {
    const {username, repo, tag} = getUrlParams();
    if(username) form.username.value = username;
    if(repo) form.repository.value = repo;
    if(tag) form.releaseTag.value = tag;
    if(username && repo) form.dispatchEvent(new Event('submit'));
  }

  function renderReleases(releases, tag='') {
    releases = releases.filter(r => r.assets && r.assets.length > 0);
    if(releases.length === 0) {
        throw new Error(`No releases with files found${tag ? ` for tag "${tag}"` : ''}`);
    }

    if(tag) {
        releases = releases.filter(r => r.tag_name === tag);
        if(releases.length === 0) {
            throw new Error(`No releases with files found${tag ? ` for tag "${tag}"` : ''}`);
        }
    }

    const totalDownloads = releases.reduce(
        (sum, r) => sum + r.assets.reduce((aSum, a) => aSum + a.download_count, 0),
        0
    );

    const totalDiv = document.createElement('div');
    totalDiv.className = 'total-downloads';
    totalDiv.innerHTML = `<i class="fas fa-download"></i> Total Downloads: <span class="downloads-count">${totalDownloads}</span>`;
    container.innerHTML = '';
    container.appendChild(totalDiv);

    releases.forEach((r, i) => {
        const card = document.createElement('div');
        card.className = 'release-card';
        card.innerHTML = `
            <div class="release-header">
                <a href="https://github.com/${r.author.login}/${form.repository.value.trim()}/releases/tag/${r.tag_name}" 
                   target="_blank" 
                   class="version-link">
                    <span class="version">${r.tag_name}${i===0 && !tag?'<span class="latest-label"><i class="fas fa-star"></i> Latest</span>':''}</span>
                </a>
                <span class="download-count"><i class="fas fa-download"></i>${r.assets.reduce((acc,a)=>acc+a.download_count,0)}</span>
            </div>
            <div class="release-meta">
                <a href="https://github.com/${r.author.login}" 
                   target="_blank" 
                   class="author-link">
                    <span class="release-author"><i class="fas fa-user"></i> Author: <span class="author-name">${r.author.login}</span></span>
                </a>
                <span class="release-date"><i class="fas fa-calendar-alt"></i> Date: ${new Date(r.published_at).toLocaleDateString()}</span>
            </div>
            <div class="file-list">
                <div class="file-list-header">
                    <span class="files-title"><i class="fas fa-file"></i> Files Name</span>
                    <span class="downloads-title"><i class="fas fa-download"></i> Downloads</span>
                </div>
                ${r.assets.map(f=>`<div class="file-item"><a href="${f.browser_download_url}" target="_blank">${f.name}</a><span>${f.download_count}</span></div>`).join('')}
            </div>
        `;
        container.appendChild(card);
    });
}

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const username = form.username.value.trim();
    const repo = form.repository.value.trim();
    const tag = form.releaseTag.value.trim();
    updateUrlParams(username, repo, tag);
    container.innerHTML = '<div class="loader"><div class="loader-spinner"></div></div>';
    try {
      const releases = await fetchAllReleases(username, repo);
      renderReleases(releases, tag);
    } catch(err) {
      container.innerHTML = `<p style="text-align:center; color: #a4d7f4;">${err.message}</p>`;
    }
  });

  autoFillFromUrl();
});
</script>

</body>
</html>
